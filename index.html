<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Instructional Design Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- REQUIRED: set your Worker base URL (no trailing slash) -->
  <script>
    window.CF_WORKER_URL = "https://id-assistant.jasons-c51.workers.dev/";
  </script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa}
    #planner{max-width:960px;margin:24px auto;padding:16px;display:grid;gap:16px}
    label{display:block}
    input,textarea{width:100%;padding:8px}
    button{padding:10px 16px;font-weight:600;cursor:pointer}
    .card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .msg{min-height:20px}
    .bad{color:#a00}
  </style>

  <!-- Helper: defines window.runAIDraft BEFORE app code -->
  <script>
    (function(){
      function base(){
        const url = (typeof window!=="undefined" && window.CF_WORKER_URL) || "";
        if(!url) throw new Error("CF_WORKER_URL is not set on window");
        return url.replace(/\/+$/,"");
      }
      async function postJSON(url, body, {signal}={}){
        const res = await fetch(url, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(body||{}),
          signal
        });
        let txt = "";
        if(!res.ok){
          try{ txt = await res.text(); }catch{}
          throw new Error("Worker error "+res.status+(txt?(": "+txt):""));
        }
        try{ return await res.json(); }catch{ return await res.text(); }
      }
      window.runAIDraft = async function runAIDraft(payload,{signal}={}){
        const raw = await postJSON(base()+"/answer", payload, {signal});
        if(typeof raw === "string" && raw.trim()) return raw;
        if(raw && typeof raw === "object"){
          const draft = raw?.data?.draft ?? raw?.draft ?? raw?.data;
          if(typeof draft === "string" && draft.trim()) return draft;
        }
        throw new Error("Empty model response");
      };
    })();
  </script>

  <!-- App (inline to remove ordering problems) -->
  <script>
    (function () {
      const byId = (id) => document.getElementById(id);
      const text = (id) => (byId(id)?.value || "").trim();

      function setMsg(t, bad = false) {
        const m = byId("aiMsg");
        if (!m) return;
        m.textContent = t;
        m.className = "msg" + (bad ? " bad" : "");
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
      }

      function buildPayload() {
        const orgName = text("orgName");
        const overview = text("overview");
        const moduleCount = parseInt(text("moduleCount") || "0", 10) || 0;
        const audience = text("audience");
        const lx = Array.from(document.querySelectorAll('input[name="lx"]:checked')).map(el => el.value);

        const prompt = [
          "ROLE: Instructional Design assistant.",
          "TASK: Return STRICT JSON only. No markdown. No prose.",
          'FORMAT: { "modules": [ { "name": "Module name", "outcomes": ["Outcome 1","Outcome 2","Outcome 3"] } ] }',
          "RULES:",
          "- If user_modules > 0, return exactly user_modules modules.",
          "- If user_modules = 0, choose a sensible number of modules.",
          "- Each module must have 3-6 outcomes.",
          '- Ban the words "understand" and "understanding".',
          "- Outcomes must be observable and measurable without percentages.",
          "",
          `ORGANIZATION: ${orgName || "TBD"}`,
          `AUDIENCE: ${audience || "TBD"}`,
          `OVERVIEW: ${overview || "TBD"}`,
          `LEARNING_EXPERIENCE_TYPES: ${lx.join(", ") || "TBD"}`,
          `USER_MODULES: ${moduleCount}`
        ].join("\n");

        return { prompt, fields: { orgName, audience, overview, lx, moduleCount } };
      }

      function parseJson(str) {
        try { return JSON.parse(str); } catch {
          const m = String(str).match(/\{[\s\S]*\}$/);
          if (!m) return {};
          try { return JSON.parse(m[0]); } catch { return {}; }
        }
      }

      function toSimpleView(obj) {
        const mods = Array.isArray(obj?.modules) ? obj.modules : [];
        const lis = mods.map(m => {
          const name = escapeHtml(m?.name || "Untitled");
          const outs = Array.isArray(m?.outcomes) ? m.outcomes : [];
          const inner = outs.map(o => `<li>${escapeHtml(String(o))}</li>`).join("");
          return `<li><b>${name}</b><ul>${inner}</ul></li>`;
        }).join("");
        return `<h3 style="margin:0 0 8px 0">Modules</h3><ol>${lis}</ol>`;
      }

      async function launch() {
        try {
          if (typeof window.runAIDraft !== "function") {
            throw new Error("window.runAIDraft is not a function");
          }
          setMsg("Launching AI...");
          const payload = buildPayload();
          const draftText = await window.runAIDraft(payload);
          const obj = parseJson(draftText);
          byId("results").innerHTML = toSimpleView(obj);
          byId("raw").textContent = JSON.stringify(obj, null, 2);
          setMsg("Done.");
        } catch (e) {
          console.error(e);
          setMsg("AI error: " + (e?.message || e), true);
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        const btn = byId("launchBtn");
        if (btn) btn.addEventListener("click", (e) => { e.preventDefault(); launch(); });
      });
    })();
  </script>
</head>
<body>
  <main id="planner">
    <h1 style="margin:0;">Instructional Design Planner</h1>

    <label>
      <div style="font-weight:600;">Organization Name</div>
      <input id="orgName" type="text" placeholder="Acme Corp">
    </label>

    <label>
      <div style="font-weight:600;">Overview</div>
      <textarea id="overview" rows="5" placeholder="Project summary, goals, constraints"></textarea>
    </label>

    <label>
      <div style="font-weight:600;">Number of Modules (leave blank for AI)</div>
      <input id="moduleCount" type="number" min="1" style="width:240px;">
    </label>

    <div>
      <div style="font-weight:600;">Learning Experience Types</div>
      <div style="display:grid;gap:8px;margin-top:8px;">
        <label><input type="checkbox" name="lx" value="Live Session"> Live Session</label>
        <label><input type="checkbox" name="lx" value="Coaching/Mentoring"> Coaching/Mentoring</label>
        <label><input type="checkbox" name="lx" value="eLearning"> eLearning</label>
        <label><input type="checkbox" name="lx" value="Software Simulation"> Software Simulation</label>
        <label><input type="checkbox" name="lx" value="Practical Application Activities"> Practical Application Activities</label>
      </div>
    </div>

    <label>
      <div style="font-weight:600;">Audience</div>
      <input id="audience" type="text" placeholder="Who will be trained">
    </label>

    <button id="launchBtn">Launch AI Assistant</button>
    <div id="aiMsg" class="msg"></div>

    <section class="card" aria-live="polite">
      <h2 style="margin:0 0 8px 0;">Result</h2>
      <div id="results"></div>
      <details style="margin-top:10px">
        <summary>Raw JSON</summary>
        <pre id="raw" class="mono">{}</pre>
      </details>
    </section>
  </main>
</body>
</html>
