<script>
// Override AI launch to parse JSON and render "Course → Outcomes".
(function(){
  // 1) Hook the button
  const aiBtn = document.getElementById('aiBtn');
  if(!aiBtn){ console.warn('aiBtn not found'); return; }
  aiBtn.onclick = handleAiLaunch;

  // 2) Small helpers
  const $ = (id)=>document.getElementById(id);
  function text(id){ const el=$(id); return el ? el.value?.trim?.() || el.textContent?.trim?.() || '' : ''; }
  function setMsg(t,bad=false){
    const m=document.getElementById('msg') || document.createElement('div');
    m.id='msg'; m.className='msg'+(bad?' bad':''); m.textContent=t;
    if(!m.parentNode){ (document.body || document.documentElement).appendChild(m); }
  }

  // 3) Build payload from your existing inputs (adjust IDs if your page uses different ones)
  function buildPayload(){
    // Gather what you already collect on the page
    const fields = {
      audience: text('audience'),
      constraints: text('constraints'),
      goals: text('goals') || text('summary') || '',
      modules: Number(document.getElementById('modules')?.value || 0) || 0
    };
    // Include a prompt if your Worker expects it; otherwise fields alone is fine
    const prompt =
`ROLE: Instructional Design assistant
TASK: Return STRICT JSON only. No markdown. No prose.
FORMAT: { "modules": [ { "name": "Module name", "outcomes": ["Outcome 1","Outcome 2","Outcome 3"] } ] }
RULES:
- If user_modules > 0, return exactly user_modules modules.
- If user_modules = 0, choose a sensible number of modules.
- Each module must have 3-6 outcomes.
- Ban the words "understand" and "understanding".
- Outcomes must be observable and measurable without percentages.

AUDIENCE: ${fields.audience || 'TBD'}
CONSTRAINTS: ${fields.constraints || 'TBD'}
GOALS: ${fields.goals || 'TBD'}
USER_MODULES: ${fields.modules}`;

    return { prompt, fields };
  }

  // 4) Parse model text safely → object
  function toJson(draftText){
    if (typeof draftText === 'object' && draftText !== null) return draftText;
    let s = String(draftText || '').trim();
    // Try direct parse
    try { return JSON.parse(s); } catch(_) {}
    // Try extracting last JSON block
    const m = s.match(/\{[\s\S]*\}$/);
    if(m){ try { return JSON.parse(m[0]); } catch(_) {} }
    throw new Error('AI returned non-JSON text');
  }

  // 5) Convert modules → Course + Outcomes list
  function toCourseOutcomes(obj){
    const mods = Array.isArray(obj.modules) ? obj.modules : [];
    const outcomes = [];
    for(const m of mods){
      if (Array.isArray(m?.outcomes)) {
        for (const o of m.outcomes) {
          if (typeof o === 'string' && o.trim()) outcomes.push(o.trim());
        }
      }
    }
    // Fallback if empty
    if(!outcomes.length) outcomes.push('Define success criteria using approved template');
    return {
      course: (document.getElementById('projectTitle')?.value || 'Course Plan').trim() || 'Course Plan',
      outcomes
    };
  }

  // 6) Render into your existing UI
  function renderCourseOutcomes(result){
    // Try to use existing areas if present; otherwise create a simple display.
    const containerId = 'aiResult';
    let box = document.getElementById(containerId);
    if(!box){
      box = document.createElement('div');
      box.id = containerId;
      // Place under your existing results area if present
      const anchor = document.querySelector('#aiOutput, #render, .card, main') || document.body;
      anchor.appendChild(box);
    }
    box.innerHTML = `
      <div class="card" style="margin-top:12px">
        <h2 style="margin:0 0 8px 0">Course</h2>
        <div>${escapeHtml(result.course)}</div>
        <h2 style="margin:16px 0 8px 0">Outcomes</h2>
        <ul>${result.outcomes.map(o=>`<li>${escapeHtml(o)}</li>`).join('')}</ul>
      </div>
    `;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
  }

  // 7) Main click handler
  async function handleAiLaunch(){
    try{
      setMsg('Launching AI…');
      const payload = buildPayload();
      // runAIDraft is provided by api/draft.js we installed earlier
      const draftText = await window.runAIDraft(payload);
      const obj = toJson(draftText);
      const result = toCourseOutcomes(obj);
      renderCourseOutcomes(result);
      setMsg('AI done.');
    }catch(e){
      console.error(e);
      setMsg('AI error: ' + (e?.message || e), true);
    }
  }
})();
</script>
